name: Deploy Quarto Site

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Setup Python with cache
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python packages with cache
        run: |
          # Installer jupyter-cache et dÃ©pendances
          python -m pip install jupyter-cache nbformat jupyter
          
          # VÃ©rifier
          python -c "import jupyter_cache; print(f'jupyter-cache: {jupyter_cache.__version__}')"

      - name: Setup R with cache
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'
          cache: 'packrat'  # ou 'renv'

      - name: Cache R packages (CRITIQUE pour la vitesse)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/R
            /usr/local/lib/R/site-library
            /opt/R/4.3.2/lib/R/library
            ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-packages-${{ hashFiles('**/*.qmd', '**/_quarto.yml') }}
          restore-keys: |
            ${{ runner.os }}-r-packages-

      - name: Cache Quarto dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/quarto
            ~/.local/share/quarto
            _extensions
          key: ${{ runner.os }}-quarto-${{ hashFiles('_quarto.yml', '**/*.qmd') }}
          restore-keys: |
            ${{ runner.os }}-quarto-

      - name: Install ONLY missing R packages
        run: |
          echo "ðŸ“¦ Installation intelligente des packages R..."
          
          # Script R pour n'installer que les packages manquants
          Rscript -e "
            # Liste des packages requis
            required <- c(
              'rmarkdown', 'knitr', 'jupyter',
              'dplyr', 'ggplot2', 'readxl', 'tidyr', 'lubridate',
              'gplots', 'car', 'lmtest', 'nortest', 'MASS',
              'RColorBrewer', 'gridExtra', 'scales'
            )
            
            # VÃ©rifier ce qui est dÃ©jÃ  installÃ©
            installed <- installed.packages()[, 'Package']
            missing <- setdiff(required, installed)
            
            if (length(missing) > 0) {
              cat('Installing', length(missing), 'missing packages:', paste(missing, collapse = ', '), '\\n')
              install.packages(missing, repos = 'https://cloud.r-project.org', quiet = TRUE)
            } else {
              cat('âœ… All packages already installed\\n')
            }
            
            # VÃ©rifier jupyter-cache spÃ©cifiquement
            if (!requireNamespace('jupyter', quietly = TRUE)) {
              cat('Installing jupyter package...\\n')
              install.packages('jupyter', repos = 'https://cloud.r-project.org')
            }
          "

      - name: Install WebR extension (cached)
        run: |
          # VÃ©rifier si l'extension existe dÃ©jÃ 
          if [ ! -d "_extensions/coatless" ]; then
            quarto add coatless/webr --no-prompt
          else
            echo "âœ… WebR extension already installed"
          fi

      - name: Render site with cached execution
        run: |
          echo "ðŸš€ Rendu avec cache..."
          
          # Nettoyer seulement si nÃ©cessaire
          if [ "${{ github.event_name }}" = "push" ]; then
            rm -rf docs/
          fi
          
          # Rendre avec utilisation du cache
          quarto render --cache --to html
          
          # GÃ©rer index.html
          [ -f "docs/index.qmd.html" ] && mv docs/index.qmd.html docs/index.html
          [ ! -f "docs/index.html" ] && echo '<html><meta http-equiv="refresh" content="0;url=qmd/"></html>' > docs/index.html
          
          # GitHub Pages requirement
          touch docs/.nojekyll

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v3