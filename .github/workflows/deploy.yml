name: Deploy Quarto Website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Python and Jupyter with cache
        run: |
          echo "ğŸ Installation Python/Jupyter..."
          python3 -m pip install --upgrade pip
          python3 -m pip install jupyter nbformat ipykernel jupyter-cache nbclient
          echo "âœ… jupyter-cache installÃ©"

      - name: Setup R with binary repository
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          use-public-rspm: true

      - name: Cache R packages
        uses: actions/cache@v3
        id: r-cache
        with:
          path: |
            /usr/local/lib/R/site-library
            ~/.R/library
          key: ${{ runner.os }}-r4.3-packages-${{ hashFiles('.github/workflows/deploy.yml') }}
          restore-keys: |
            ${{ runner.os }}-r4.3-packages-

      - name: Install system dependencies
        run: |
          echo "ğŸ“¦ DÃ©pendances systÃ¨me..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev \
            libharfbuzz-dev \
            libfribidi-dev

      - name: Install R packages FAST (with RSPM binaries)
        if: steps.r-cache.outputs.cache-hit != 'true'
        run: |
          echo "âš¡ Installation ULTRA RAPIDE des packages R via RSPM..."
          
          # Configuration R pour RSPM (binaires Ubuntu 22.04)
          cat > ~/.Rprofile << 'EOF'
          # Configuration GitHub Actions - RSPM pour binaires
          local({
            os <- Sys.info()[["sysname"]]
            if (os == "Linux") {
              options(repos = c(
                RSPM = "https://packagemanager.rstudio.com/cran/__linux__/jammy/latest",
                CRAN = "https://cloud.r-project.org"
              ))
              options(install.packages.compile.from.source = "never")
            } else {
              options(repos = c(CRAN = "https://cloud.r-project.org"))
            }
            options(Ncpus = 4)
            options(INSTALL_opts = "--no-multiarch --no-docs --no-test-load")
          })
          EOF
          
          echo "ğŸ” Configuration des dÃ©pÃ´ts R :"
          Rscript -e "getOption('repos')"
          
          Rscript -e "
          start_time <- Sys.time()
          all_pkgs <- c('rmarkdown', 'knitr', 'tinytex', 'dplyr', 'ggplot2', 
                       'tidyr', 'readxl', 'lubridate', 'car', 'lmtest', 'gplots',
                       'stringr', 'purrr', 'tibble', 'rlang')
          
          cat('ğŸ“¦ Installation de', length(all_pkgs), 'packages...\\n')
          
          install_with_retry <- function(pkgs, retries = 2) {
            for (i in 1:retries) {
              tryCatch({
                install.packages(pkgs, quiet = TRUE, Ncpus = 4)
                cat('âœ… Installation rÃ©ussie (tentative', i, ')\\n')
                return(TRUE)
              }, error = function(e) {
                if (i == retries) {
                  cat('âŒ Ã‰chec aprÃ¨s', retries, 'tentatives:\\n', e$message, '\\n')
                  return(FALSE)
                }
                cat('âš ï¸ Tentative', i, 'Ã©chouÃ©e, rÃ©essaye...\\n')
                Sys.sleep(3)
              })
            }
          }
          
          install_with_retry(c('rmarkdown', 'knitr'))
          install_with_retry(c('dplyr', 'ggplot2', 'tidyr'))
          install_with_retry(c('readxl', 'lubridate', 'stringr', 'purrr'))
          install_with_retry(c('car', 'lmtest', 'gplots'))
          
          cat('\\nâœ… VÃ©rification des installations...\\n')
          installed <- rownames(installed.packages())
          
          for (pkg in all_pkgs) {
            if (pkg %in% installed) cat('âœ“', pkg, '\\n')
            else cat('âœ—', pkg, '(MANQUANT)\\n')
          }
          
          end_time <- Sys.time()
          cat('\\nâ±ï¸ Temps total:', round(difftime(end_time, start_time, units = 'mins'), 1), 'minutes\\n')
          "
          
          echo "ğŸ¯ Packages R installÃ©s avec succÃ¨s!"

      - name: Install TinyTeX (for PDF if needed)
        run: |
          echo "ğŸ“„ Installation de TinyTeX..."
          Rscript -e "
          if(!requireNamespace('tinytex', quietly = TRUE)) {
            install.packages('tinytex')
          }
          tinytex::install_tinytex()
          "

      - name: Clean temporary files
        run: |
          echo "ğŸ§¹ Nettoyage..."
          rm -rf _freeze/ .quarto-cache/ 2>/dev/null || true

      - name: Render website
        run: |
          echo "ğŸš€ Rendu du site web..."
          
          # Nettoyer docs AVANT de rendre
          rm -rf docs/
          
          # Rendu
          quarto render --cache
          
          # Post-traitement CRITIQUE
          if [ -f "docs/index.qmd.html" ]; then
            mv docs/index.qmd.html docs/index.html
            echo "âœ… index.qmd.html renommÃ© en index.html"
          fi
          
          echo "âœ… GÃ©nÃ©ration terminÃ©e!"

      - name: Disable Jekyll for GitHub Pages
        run: |
          echo "ğŸ›‘ DÃ‰SACTIVATION DE JEKYLL..."
          
          # S'assurer que docs/ existe
          mkdir -p docs
          
          # 1. CrÃ©er .nojekyll (mÃ©thode principale)
          echo "Creating .nojekyll file..."
          touch docs/.nojekyll
          
          # 2. CrÃ©er un fichier vide pour dÃ©sactiver Jekyll complÃ¨tement
          echo "Creating empty .jekyll file..."
          echo "" > docs/.jekyll 2>/dev/null || true
          
          # 3. Supprimer tout dossier _site qui pourrait exister
          echo "Removing any _site directory..."
          rm -rf docs/_site 2>/dev/null || true
          
          # 4. Supprimer tout fichier de configuration Jekyll
          echo "Removing Jekyll config files..."
          rm -f docs/_config.yml docs/Gemfile docs/Gemfile.lock 2>/dev/null || true
          
          # 5. Lister les fichiers pour vÃ©rification
          echo "ğŸ“ Contenu de docs/:"
          ls -la docs/
          echo "ğŸ” VÃ©rification .nojekyll:"
          ls -la docs/.nojekyll || echo ".nojekyll non trouvÃ©"
          
          echo "âœ… Jekyll dÃ©sactivÃ© avec succÃ¨s"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3